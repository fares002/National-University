// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
generator client {
provider = "prisma-client-js"
}
datasource db {
provider = "mysql"
url      = env("DATABASE_URL")
}

enum Role {
admin
auditor
}

enum FeeType {
NEW_YEAR
SUPPLEMENTARY
TRAINING
STUDENT_SERVICES
OTHER
EXAM
}

enum PaymentMethod {
CASH
TRANSFER
CHEQUE
}

model User {
id           String   @id @default(cuid())
username     String   @unique @db.VarChar(50)
email        String   @unique @db.VarChar(100)
role         Role
passwordHash String   @map("password_hash") @db.VarChar(255)
lastLoginAt     DateTime    @default(now())
createdAt    DateTime @default(now()) @map("created_at")
updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")
// Relations
createdPayments Payment[]
createdExpenses Expense[]


//main indexs
@@index([role])                 
@@index([lastLoginAt])           
@@index([createdAt])

//compined indexes
@@index([role, lastLoginAt])   
@@index([role, createdAt])   
@@map("users")
}


model Payment {
id             String   @id @default(uuid())
studentId      String
studentName    String
feeType        FeeType
amount         Decimal  @db.Decimal(15, 2)
currency       String   @default("EGP")
amountUSD      Decimal? @db.Decimal(15, 2)
usdAppliedRate    Decimal? @db.Decimal(10, 6)
receiptNumber  String   @unique
paymentMethod  PaymentMethod
paymentDate    DateTime
notes          String?
createdBy      User     @relation(fields: [createdById], references: [id])
createdById    String
createdAt      DateTime @default(now())
updatedAt      DateTime @updatedAt

// Main indexies
@@index([paymentDate])
@@index([feeType])
@@index([paymentMethod])
@@index([createdById])    

//compined indexes
@@index([paymentDate, feeType])
@@index([paymentDate, paymentMethod])
@@index([createdById, paymentDate])


//Rare indexes
@@index([studentId])
@@index([receiptNumber])

@@map("payments")
}


model Expense {
id          String   @id @default(cuid()) 
amount      Decimal  @db.Decimal(15, 2)
currency    String   @default("EGP")
amountUSD   Decimal? @db.Decimal(15, 2)
usdAppliedRate Decimal? @db.Decimal(10, 6)
description String   @db.Text
category    String   @db.VarChar(100)
vendor      String?  @db.VarChar(255)
receiptUrl  String?  @map("receipt_url") @db.VarChar(500)
date        DateTime @db.Date
createdBy   String  @map("created_by") 
createdAt   DateTime @default(now()) @map("created_at")
updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
// Relations
creator User @relation(fields: [createdBy], references: [id])

//Main indexes
@@index([date])
@@index([category])
@@index([vendor])
@@index([createdBy]) 

//compaind indexes
@@index([date, category])
@@index([date, vendor])
@@index([createdBy, date])
@@map("expenses")
}

model CurrencyRate {
id        String   @id @default(cuid()) 
currency  String   @default("USD")
rate      Decimal  @db.Decimal(10, 6)
validFrom DateTime @default(now())
isActive  Boolean  @default(true)
createdAt DateTime @default(now())
updatedAt DateTime @updatedAt

@@index([currency, isActive])
@@index([validFrom])
@@map("currency_rates")
}